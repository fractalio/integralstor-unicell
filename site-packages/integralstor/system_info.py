import json

from integralstor import zfs, config, zfs


def load_system_config(first_time=False):

    return_dict = {}
    try:
        if first_time:
            system_status_path, err = config.get_tmp_path()
            if err:
                raise Exception(err)
        else:
            system_status_path, err = config.get_system_status_path()
            if err:
                raise Exception(err)

        msfn = "%s/master.status" % system_status_path
        mmfn = "%s/master.manifest" % system_status_path

        try:
            with open(msfn, "r") as f:
                status_dict = json.load(f)
            with open(mmfn, "r") as f:
                manifest_dict = json.load(f)
        except IOError:
            raise Exception('file-not-found')

        # First load the return dict with the manifest keys
        return_dict = manifest_dict.copy()

        for k in return_dict.keys():
            if k in status_dict.keys():
                if k in ['disks', 'interfaces', 'memory']:
                    for component in return_dict[k].keys():
                        if component in status_dict[k].keys():
                            for component_key in status_dict[k][component].keys():
                                if component_key not in return_dict[k][component].keys():
                                    return_dict[k][component][component_key] = status_dict[k][component][component_key]
        for k in status_dict.keys():
            if k not in return_dict.keys():
                return_dict[k] = status_dict[k]

    except Exception, e:
        if str(e) is "file-not-found":
            return None, '<a href="/update_manifest"> <h4>System configuartion not loaded, click here to regenerate.</h4></a>'
        else:
            return None, 'Error loading system configuration : %s' % str(e)
    else:
        return return_dict, None


# vim: tabstop=8 softtabstop=0 expandtab ai shiftwidth=4 smarttab
