from integralstor import command
import re, sys

def get_enclosure_devices():
    # Returns a list of /dev/sgX path for Connected Storage Enclosures
    enclosures = []
    try:
        sg_devs, err = command.get_command_output('sg_map -i')
        if err:
            raise Exception(err)

        if sg_devs:
            for sg_dev in sg_devs:
                    encl = re.findall('ENCL', sg_dev, re.IGNORECASE)
                    if encl:
                        res = re.findall(r'^\/\w+\/\w+', sg_dev)
                        if res:
                            enclosures += res
                    else:
                        raise Exception("No enclosures found")
    except Exception, e:
        return None, "Error retrieving enclosures : %s" % str(e)
    else:
        return enclosures, None

def get_psu_status():
    psu_status = []
    try:
        encls, err = get_enclosure_devices()
        if err:
            raise Exception(err)

        if encls:
            for encl in encls:
                for psu in range(2):
                    tmp_cmd_output, err = command.get_command_output('sg_ses --index=ps,%d %s' % (psu, encl))
                    if err:
                        raise Exception(err)
                    if tmp_cmd_output:
                        for status_line in tmp_cmd_output:
                            result = re.findall(r'status: \w+', status_line)
                            if result:
                                psu_status.append(result[0])
                            else:
                                raise Exception("Unable to fetch PSU status")
    except Exception, e:
        return None, "Error retrieving JBOD PSU status : %s" % str(e)
    else:
        return psu_status, None

#vim: tabstop=8 softtabstop=0 expandtab ai shiftwidth=4 smarttab
